#!/bin/sh

export LEIN_VERSION="1.4.0"

if [ "$USER" = "root" ] && [ "$LEIN_ROOT" = "" ]; then
    echo "WARNING: You're currently running as root; probably by accident."
    echo "Press control-C to abort or Enter to continue as root."
    echo "Set LEIN_ROOT to disable this warning."
    read
fi

ORIGINAL_PWD="$PWD"
while [ ! -r "$PWD/project.clj" ] && [ "$PWD" != "/" ] && [ ! $NOT_FOUND ]
do
    cd ..
    if [ "$(dirname "$PWD")" = "/" ]; then
        NOT_FOUND=0
        cd "$ORIGINAL_PWD"
    fi
done

if [ "$LEIN_HOME" = "" ]; then
    LEIN_HOME="$HOME/.lein"
fi

LEIN_PLUGINS="$(ls -1 lib/dev/*jar 2> /dev/null | tr \\n \:)"
LEIN_USER_PLUGINS="$(ls -1 $LEIN_HOME/plugins/*jar 2> /dev/null | tr \\n \:)"
CLASSPATH=$LEIN_USER_PLUGINS:$LEIN_PLUGINS:test/:src/:$CLASSPATH
# TODO: find lein and dependencies
LEIN_JAR="$HOME/.lein/self-installs/leiningen-$LEIN_VERSION-standalone.jar"
CLOJURE_JAR="$HOME/.m2/repository/org/clojure/clojure/1.2.0/clojure-1.2.0.jar"
NULL_DEVICE=/dev/null

CLASSPATH="$LEIN_JAR:$CLASSPATH"

JAVA_CMD=${JAVA_CMD:-"java"}

if [ $DEBUG ]; then
    echo $CLASSPATH
    echo $CLOJURE_JAR
fi

# Use rlwrap if it's available
if ([ "$1" = "repl" ] || [ "$1" = "interactive" ] || [ "$1" = "int" ]) &&
    [ -z $INSIDE_EMACS ] && [ "$TERM" != "dumb" ]; then
    RLWRAP=`which rlwrap`
fi

# The -Xbootclasspath argument is optional here: if the jar
# doesn't exist everything will still work, it will just have a
# slower JVM boot.
exec $RLWRAP $JAVA_CMD -Xbootclasspath/a:"$CLOJURE_JAR" -client $JAVA_OPTS \
    -cp "$CLASSPATH" clojure.main -e "(use 'leiningen.core)(-main)" \
    $NULL_DEVICE $@
